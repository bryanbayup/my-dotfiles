var desktopCaptureInterval=null;function beginDesktop(){chrome.desktopCapture.chooseDesktopMedia(["screen","window"],(function(e){if(e){var t={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:3840,maxHeight:2160}}};window.navigator.mediaDevices.getUserMedia(t).then((async function(e){var t=await getOptionStorage("desktop_delay_sec");t||(t=0);var o=document.createElement("video");o.setAttribute("autoplay","true"),o.addEventListener("play",(function(){if(sendMiniWindow(),parseInt(t)>0){e.getVideoTracks()[0].onended=()=>{desktopCaptureInterval&&(clearInterval(desktopCaptureInterval),chrome.action.setBadgeText({text:""})),window.close()};var n=parseInt(t);chrome.action.setBadgeText({text:n+""}),n--,desktopCaptureInterval=setInterval((function(){0!==n?(chrome.action.setBadgeText({text:n+""}),n--):(clearInterval(desktopCaptureInterval),chrome.action.setBadgeText({text:""}),setTimeout((async function(){var t=document.createElement("canvas"),n=t.getContext("2d");t.width=o.videoWidth,t.height=o.videoHeight,n.drawImage(o,0,0,t.width,t.height),o.pause(),o.srcObject=null,finishCapture(t.toDataURL()),e.getVideoTracks()[0].stop()}),300))}),1e3)}else setTimeout((function(){var t=document.createElement("canvas"),n=t.getContext("2d");t.width=o.videoWidth,t.height=o.videoHeight,n.drawImage(o,0,0,t.width,t.height),o.pause(),o.srcObject=null,finishCapture(t.toDataURL()),e.getVideoTracks()[0].stop()}),800)}),!1),o.srcObject=e}),(function(e){var t="",o="";if(e){if("NotAllowedError"===e.name?/Permission denied by system/.test(e)?(t="mac",/Mac OS/.test(window.navigator.userAgent)||(t="win")):/Could not start audio source/.test(e)&&(t="win",o="mic"):"NotReadableError"===e.name&&(t="mac",o="browser_issue",/Mac OS/.test(window.navigator.userAgent)||(t="win",o="mic")),t){var n="/permission-denied.html?os="+t;o&&(n+="&type="+o),chrome.tabs.create({url:n})}window.close()}}))}else window.close()}))}function getOptionStorage(e){return new Promise((t=>{chrome.storage.local.get("options",(o=>{t(e?o.options[e]:o.options)}))}))}function sendMiniWindow(){chrome.runtime.sendMessage({action:"miniWindow"})}function finishCapture(e){chrome.runtime.sendMessage({action:"desktop_capture",data:e},(e=>{window.close()}))}beginDesktop();