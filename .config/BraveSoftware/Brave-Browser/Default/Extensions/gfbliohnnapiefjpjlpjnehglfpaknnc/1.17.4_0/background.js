(()=>{"use strict";function e(e,t){chrome.storage.local.get(["logLevels"],(n=>{const o=n&&n.logLevels||["error"];-1!==["log","warn","error"].indexOf(e)&&-1!==o.indexOf(e)&&console[e](t)}))}function t(e,t,n){if(t&&t.length){var o=function(e,t,n){var o=null;const r=t?"g":"gi";if(e=e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&"),n)o=new RegExp(e.replace(/\s+/,"|"),r);else{var i=e.split(/\s+/).map((function(e){return`(?=.*${e})`})).join("");o=new RegExp(`^${i}.*$`,r)}return o}(t,n,!1);e=e.filter((function(e){return o.test(e.title)||o.test(e.url)}))}return e}function n(e,t,n,o,r){n=n||{};const i=/(?:charset|encoding)\s*=\s*['"]? *([\w\-]+)/i;fetch(e,{method:void 0!==o?"POST":"GET",headers:n,body:o}).then((e=>{const t=e.headers.get("content-type")?e.headers.get("content-type").match(i):[];return Promise.all([Promise.resolve(t&&t.length>1?t[1]:"utf-8"),e.arrayBuffer()])})).then((e=>{const n=new TextDecoder(e[0]).decode(e[1]);t(n)})).catch((e=>{r&&r(e)}))}function o(e,t){var n={};return e.forEach((function(e){n[e]=t})),n}function r(e,t){for(var n in t)e[n]=t[n]}function i(e,t){var n;return t?(t instanceof Array||(t=[t]),n={},t.forEach((function(t){n[t]=e[t]}))):n=e,n}function s(e,t,o){e===chrome.storage.sync?(t.localPath&&(delete t.snippets,delete t.localPath),Object.keys(t).length>1&&e.set(t,o)):t.localPath?(delete t.snippets,n(t.localPath,(function(n){t.snippets=n,e.set(t,o)}))):e.set(t,o)}var a=function(){var e={};var t,o="",r=[];function i(e,r){n(`https://api.github.com/gists/${o}/comments`,(function(e){r&&r(e)}),{Authorization:"token "+t},`{"body": "${encodeURIComponent(e)}"}`)}function s(e,r){n(`https://api.github.com/gists/${o}/comments/${e}`,(function(e){var t=JSON.parse(e);r({status:0,content:decodeURIComponent(t.body)})}),{Authorization:"token "+t})}function a(e){n(`https://api.github.com/gists/${o}/comments`,(function(t){r=JSON.parse(t).map((function(e){return e.id})),e(r)}),{Authorization:"token "+t})}function c(e,r,i){n(`https://api.github.com/gists/${o}/comments/${e}`,(function(e){i&&i(e)}),{Authorization:"token "+t},`{"body": "${encodeURIComponent(r)}"}`)}return e.initGist=function(e,r){if(t===e&&""!==o)return o;!function(e,t,o){n("https://api.github.com/gists",(function(r){var i=JSON.parse(r),s="";i.forEach((function(e){e.hasOwnProperty("description")&&e.description===t&&e.files.hasOwnProperty(t)&&(s=e.id)})),""===s?n("https://api.github.com/gists",(function(e){var t=JSON.parse(e);o(t.id)}),{Authorization:"token "+e},`{ "description": "${t}", "public": false, "files": { "${t}": { "content": "${t}" } } }`):o(s)}),{Authorization:"token "+e})}(t=e,"cloudboard",(function(e){o=e,r&&r(o)}))},e.readComment=function(e,t){""===o?t({status:1,content:"Please call initGist first!"}):e>=r.length?a((function(n){e<n.length?s(n[e],t):t({status:1,content:"Register not exists!"})})):s(r[e],t)},e.editComment=function(e,t,n){""===o?n({status:1,content:"Please call initGist first!"}):e>=r.length?a((function(o){if(e<o.length)c(o[e],t,n);else{var r=e-o.length+1;function s(){--r>0?i(".",s):0===r&&i(t,n)}s()}})):c(r[e],t,n)},e}();let c=!1;const u={};u.instance=function t(){return new Promise(((n,o)=>{const r=chrome.runtime.connectNative("surfingkeys"),i=function(){const e=new Uint32Array(8);return self.crypto.getRandomValues(e),Array.from(e).join("")}();r.onDisconnect.addListener((n=>{if(chrome.runtime.lastError)chrome.runtime.lastError.message;c?u.instance=t():(delete u.instance,e("error","Failed to connect neovim, please make sure your neovim version 0.5 or above."))})),r.onMessage.addListener((async t=>{if(!0===t.status){if(c=!0,"serverStarted"===t.res.event){const e=`127.0.0.1:${t.res.port}/${i}`;n({url:e,nm:r})}}else t.err&&e("error",t.err)})),r.postMessage({startServer:!0,password:i})}))}(),function(e){var i={};const c=3===chrome.runtime.getManifest().manifest_version;var u=[],l=0,d=0,f=!1,h={},m={},p={},b=e._setNewTabUrl(),g={focusAfterClosed:"right",repeatThreshold:99,tabsMRUOrder:!0,newTabPosition:"default",showTabIndices:!1,interceptedErrors:[]},y=[];function v(e,t){var n=t;if(""===e.title||e.hasOwnProperty("url")&&void 0!==e.url||(n+="/"+e.title,y.push({id:e.id,title:n+"/"})),e.hasOwnProperty("children"))for(var o=0;o<e.children.length;++o)v(e.children[o],n)}function w(e,t){e.path.length?chrome.bookmarks.create({parentId:e.folder,title:e.path.shift()},(function(n){e.folder=n.id,w(e,t)})):chrome.bookmarks.create({parentId:e.folder,title:e.title,url:e.url},(function(e){t(e)}))}function x(t,o){e.loadRawSettings(t,(function(e){"string"==typeof e.proxy&&(e.proxy=[e.proxy],e.autoproxy_hosts=[e.autoproxy_hosts]),e.localPath?n(e.localPath,(function(t){e.snippets=t,o(e)}),void 0,void 0,(function(t){e.error="Failed to read snippets from "+e.localPath,o(e)})):o(e)}),{blocklist:{},marks:{},findHistory:[],cmdHistory:[],sessions:{},proxyMode:"clear",autoproxy_hosts:[],proxy:[]})}function k(e){if(m.hasOwnProperty(e)){const t=m[e];T(e,0,{subject:"setScrollPos",scrollLeft:t.scrollLeft,scrollTop:t.scrollTop}),delete m[e]}}function T(e,t,n,o){-1===t?chrome.tabs.sendMessage(e,n):chrome.tabs.sendMessage(e,n,{frameId:t})}x(null,e._applyProxySettings),chrome.tabs.onRemoved.addListener((function(e){delete h[e],delete m[e],delete p[e],u=u.filter((function(t){return t!==e})),z.length&&chrome.tabs.create({active:!1,url:z.shift()}),U()}));var I=null;function S(e){I!==e&&(null!==I&&T(I,0,{subject:"tabDeactivated"}),T(e,0,{subject:"tabActivated"}),I=e)}function P(e){chrome.tabs.query({active:!0,currentWindow:!0},(function(t){t.length>0&&e(t[0])}))}function L(e,t,n){var o=i.pendingPorts.indexOf(e);-1!==o&&i.pendingPorts.splice(o,1),t(n)}function R(e,t,n){if(i.hasOwnProperty(e.action)){e.repeats>g.repeatThreshold&&(e.repeats=g.repeatThreshold);var o=i[e.action](e,t,n);if(e.needResponse)return o?(n(o),e.needResponse=!1):i.pendingPorts.push(e),e.needResponse}else console.log("[unexpected runtime message] "+JSON.stringify(e))}function O(e){chrome.tabs.query({},(function(t){t.forEach((function(t){T(t.id,-1,{subject:"settingsUpdated",settings:e})}))}))}function E(e,t){O(e),function(e,t){e.savedAt=(new Date).getTime(),s(chrome.storage.local,e,(function(){s(chrome.storage.sync,e,(function(){chrome.runtime.lastError&&chrome.runtime.lastError.message})),t&&t()}))}(e,t)}function U(){g.showTabIndices&&chrome.tabs.query({currentWindow:!0},(function(e){e.forEach((function(e){T(e.id,0,{subject:"tabIndexChange",index:e.index+1})}))}))}function C(e){return 0!==e.frameId&&"about:blank"===e.url?e.tab.url:e.url}function q(e,t,n,o){if(e.blocklist[".*"])return"disabled";if(t){if(e.blocklist[t.origin])return"disabled";if(n&&(n=new RegExp(n.source,n.flags)).test(t.href))return"disabled";if(o&&(o=new RegExp(o.source,o.flags)).test(t.href))return"lurking"}return"enabled"}function M(e,n){return t(e=e.filter((function(e){return e.url})),n,!1)}function A(t,n,o,r){e.getLatestHistoryItem(t,n,(e=>{r&&(e=e.sort((function(e,t){return t.visitCount-e.visitCount}))),o(e)}))}function _(e,t){chrome.windows.update(e,{focused:!0},(function(){chrome.tabs.update(t,{active:!0})}))}function $(e,t){return e<0?e=0:e>=t&&(e=t),e}function j(e,t){e?chrome.tabs.query({windowId:e.windowId},(function(n){0==e.index&&-1==t?t=n.length-1:e.index==n.length-1&&1==t&&(t=1-n.length);var o=$(e.index+t,n.length-1);chrome.tabs.update(n[o].id,{active:!0})})):P((function(e){j(e,t)}))}function G(e,t,n){e?chrome.tabs.query({windowId:e.windowId},(function(o){var r=o.map((function(e){return e.id}));t=$(t,o.length);var i=function(e,t,n){return t>n-e&&(e-=t-(n-e)),e}(e.index,t,o.length);n(r.slice(i,i+t))})):P((function(e){G(e,t,n)}))}function F(e,t){chrome.tabs.query({currentWindow:!0},(function(n){n=n.map((function(e){return e.id})),chrome.tabs.remove(n.slice(e.tab.index+(t<0?t:1),e.tab.index+(t<0?0:1+t)))}))}chrome.tabs.onUpdated.addListener((function(t,n,o){"complete"===n.status&&o.active&&S(t),e.detectTabTitleChange&&n.title&&T(t,0,{subject:"titleChanged",changeInfo:n})})),chrome.windows.onFocusChanged.addListener((function(e){P((function(e){S(e.id)}))})),chrome.tabs.onCreated.addListener((function(e){U()})),chrome.tabs.onMoved.addListener((function(){U()})),chrome.tabs.onActivated.addListener((function(e){f||e.tabId==u[u.length-1]||(u.length>10&&u.shift(),l!=u.length-1&&u.splice(l+1,u.length-1),u.push(e.tabId),l=u.length-1),h[e.tabId]=(new Date).getTime(),S(e.tabId),f=!1,d=0,U()})),chrome.tabs.onDetached.addListener((function(){U()})),chrome.tabs.onAttached.addListener((function(){U()})),chrome.commands.onCommand.addListener((function(e){switch(e){case"restartext":chrome.tabs.query({},(function(e){e.forEach((function(e){chrome.tabs.reload(e.id)})),chrome.runtime.reload()}));break;case"previousTab":case"nextTab":P((function(t){var n="previousTab"===e?t.index-1:t.index+1;chrome.tabs.query({windowId:t.windowId},(function(e){n=(n%e.length+e.length)%e.length,chrome.tabs.update(e[n].id,{active:!0})}))}));break;case"closeTab":P((function(e){chrome.tabs.remove(e.id)}));break;case"proxyThis":P((function(e){H({host:new URL(e.url||e.pendingUrl).host,operation:"toggle"},(function(){chrome.tabs.reload(e.id,{bypassCache:!0})}))}))}})),i.pendingPorts=[],chrome.runtime.onMessage.addListener(R),c&&(chrome.runtime.onUserScriptMessage.addListener(((e,t,n)=>{e.fromUserScript=!0,R(e,t,n)})),chrome.runtime.onInstalled.addListener((e=>{chrome.userScripts.configureWorld({csp:"script-src 'self' 'unsafe-eval'",messaging:!0})}))),i.toggleBlocklist=function(e,t,n){x("blocklist",(function(o){var r=".*",i=t.origin||new URL(C(t)).origin;0!==chrome.runtime.getURL("/").indexOf(i)&&"null"!==i&&(r=i),o.blocklist.hasOwnProperty(r)?delete o.blocklist[r]:o.blocklist[r]=1,E({blocklist:o.blocklist},(function(){n({state:q(o,t.tab?new URL(C(t)):null,e.blocklistPattern,e.lurkingPattern),blocklist:o.blocklist,url:r})}))}))},i.toggleMouseQuery=function(e,t,n){x("mouseSelectToQuery",(function(n){if(t.tab&&0!==t.tab.url.indexOf(chrome.runtime.getURL("/"))){var o=n.mouseSelectToQuery||[],r=o.indexOf(e.origin);-1===r?o.push(e.origin):o.splice(r,1),E({mouseSelectToQuery:o})}}))},i.getState=function(e,t,n){x(["blocklist","noPdfViewer","proxyMode","proxy"],(function(o){t.tab&&L(e,n,{noPdfViewer:o.noPdfViewer,proxyMode:o.proxyMode,proxy:o.proxy,state:q(o,new URL(C(t)),e.blocklistPattern,e.lurkingPattern)})}))},i.addVIMark=function(e,t,n){x("marks",(function(t){r(t.marks,e.mark),E({marks:t.marks})}))},i.jumpVIMark=function(e,t,n){x("marks",(function(o){var r=o.marks;if(r.hasOwnProperty(e.mark)){var s=r[e.mark];chrome.tabs.query({},(function(e){0===(e=e.filter((function(e){return e.url===s.url}))).length?(s.tab={tabbed:!0,active:!0},i.openLink(s,t,n)):((s.scrollLeft||s.scrollTop)&&(m[e[0].id]={scrollLeft:s.scrollLeft,scrollTop:s.scrollTop}),e[0].id===t.tab.id?k(e[0].id):chrome.tabs.update(e[0].id,{active:!0}))}))}}))},i.resetSettings=function(t,n,o){chrome.storage.local.clear(),chrome.storage.sync.clear(),x(null,(function(n){e._applyProxySettings(n),L(t,o,{settings:n}),O(n)}))},i.loadSettingsFromUrl=function(e,t,o){var r,i;r=e.url,i=function(t){L(e,o,t)},n(r,(function(e){E({localPath:r,snippets:e}),i({status:"Succeeded",snippets:e})}),void 0,void 0,(function(e){i({status:"Failed"})}))},i.getRecentlyClosed=function(e,t,n){chrome.sessions.getRecentlyClosed({},(function(t){for(var o=[],r=0;r<t.length;r++){var i=t[r];i.hasOwnProperty("window")?o=o.concat(i.window.tabs):i.hasOwnProperty("tab")&&o.push(i.tab)}o=M(o,e.query),L(e,n,{urls:o})}))},i.getTopSites=function(e,t,n){chrome.topSites?chrome.topSites.get((function(t){t=M(t,e.query),L(e,n,{urls:t})})):L(e,n,{urls:[]})},i.getAllURLs=function(e,t,n){chrome.bookmarks.search(e.query||{},(function(t){var o=t,r=e.maxResults||100,i=r-o.length;i>0?A(e.query||"",i,(function(t){o=o.concat(t),L(e,n,{urls:o})}),!0):L(e,n,{urls:o.slice(0,r)})}))},i.getTabs=function(e,t,n){var o=t.tab,r=e.queryInfo||{};chrome.tabs.query(r,(function(t){(t=M(t,e.filter)).length>e.tabsThreshold&&g.tabsMRUOrder&&(t=t.filter((function(e){return e.id!==o.id}))).sort((function(e,t){var n=h[e.id],o=h[t.id];return isFinite(n)||isFinite(o)?isFinite(n)?isFinite(o)?o-n:-1:1:0})),L(e,n,{tabs:t})}))},i.togglePinTab=function(e,t,n){P((function(e){return chrome.tabs.update(e.id,{pinned:!e.pinned})}))},i.focusTab=function(e,t,n){void 0!==e.windowId&&t.tab.windowId!==e.windowId?_(e.windowId,e.tabId):chrome.tabs.update(e.tabId,{active:!0})},i.focusTabByIndex=function(e,t,n){var o=e.queryInfo||{currentWindow:!0};chrome.tabs.query(o,(function(t){e.repeats>0&&e.repeats<=t.length&&chrome.tabs.update(t[e.repeats-1].id,{active:!0})}))},i.goToLastTab=function(e,t,n){if(u.length>1){var o=u[u.length-2];chrome.tabs.update(o,{active:!0})}},i.historyTab=function(e,t,n){if(u.length>0){f=!0,e.hasOwnProperty("index")?l=(parseInt(e.index)+u.length)%u.length:(l+=e.backward?-1:1)<0?l=0:l>=u.length&&(l=u.length-1);const t=u[l];chrome.tabs.update(t,{active:!0})}},i.nextTab=function(e,t,n){j(t.tab,e.repeats)},i.previousTab=function(e,t,n){j(t.tab,-e.repeats)},i.reloadTab=function(e,t,n){G(t.tab,e.repeats,(function(t){t.forEach((function(t){chrome.tabs.reload(t,{bypassCache:e.nocache})}))}))},i.closeTab=function(e,t,n){G(t.tab,e.repeats,(function(e){chrome.tabs.remove(e,(function(){"left"===g.focusAfterClosed?j(t.tab,-1):"last"===g.focusAfterClosed&&i.historyTab({backward:!0})}))}))},i.closeTabLeft=function(e,t,n){F(t,-e.repeats)},i.closeTabRight=function(e,t,n){F(t,e.repeats)},i.closeTabsToLeft=function(e,t,n){F(t,-t.tab.index)},i.closeTabsToRight=function(e,t,n){chrome.tabs.query({currentWindow:!0},(function(e){F(t,e.length-t.tab.index)}))},i.tabOnly=function(e,t,n){chrome.tabs.query({currentWindow:!0},(function(e){e=e.filter((function(e){return e.id!=t.tab.id&&!e.pinned})).map((function(e){return e.id})),chrome.tabs.remove(e)}))},i.closeAudibleTab=function(e,t,n){chrome.tabs.query({audible:!0},(function(e){e&&chrome.tabs.remove(e[0].id)}))},i.muteTab=function(e,t,n){var o=t.tab;chrome.tabs.update(o.id,{muted:!o.mutedInfo.muted})},i.openLast=function(e,t,n){chrome.sessions.restore()},i.duplicateTab=function(e,t,n){chrome.tabs.duplicate(t.tab.id,(function(){!1===e.active&&chrome.tabs.update(t.tab.id,{active:!0})}))};let N=-1;function D(e,t,n){return e.filter((function(e){var o=e.title,r=e.url;return n||(o=o.toLowerCase(),r=r&&r.toLowerCase(),t=t.toLowerCase()),-1!==o.indexOf(t)||r&&-1!==r.indexOf(t)}))}function W(e,t,n){var o;if(e)switch(g.newTabPosition){case"left":o=e.index;break;case"right":o=e.index+1;break;case"first":o=0;break;case"last":break;default:o=e.index+1+d,d++}chrome.tabs.create({url:t,active:n.tab.active,index:o,pinned:n.tab.pinned,openerTabId:e.id},(function(e){(n.scrollLeft||n.scrollTop)&&(m[e.id]={scrollLeft:n.scrollLeft,scrollTop:n.scrollTop})}))}function B(){try{if(chrome.userScripts)return!0}catch{return!1}return!1}function V(){chrome.windows.getAll({populate:!1},(function(e){e.forEach((function(e){chrome.windows.remove(e.id)}))}))}function H(t,n){x(["proxyMode","proxy","autoproxy_hosts"],(function(r){if("deleteProxyPair"===t.operation)r.proxy.splice(t.number,1),r.autoproxy_hosts.splice(t.number,1);else if("set"===t.operation)r.proxyMode=t.mode,r.proxy=t.proxy,r.autoproxy_hosts=t.host;else if(t.mode&&(r.proxyMode=t.mode),t.number||(t.number=0),t.proxy&&(r.proxy[t.number]=t.proxy,r.autoproxy_hosts.length<=t.number&&(r.autoproxy_hosts[t.number]=[])),t.host){var i=o(r.autoproxy_hosts[t.number],1),s=t.host.split(/\s*[ ,\n]\s*/);"toggle"===t.operation?s.forEach((function(e){i.hasOwnProperty(e)?delete i[e]:i[e]=1})):"add"===t.operation?s.forEach((function(e){i[e]=1})):s.forEach((function(e){delete i[e]})),r.autoproxy_hosts[t.number]=Object.keys(i)}var a={autoproxy_hosts:r.autoproxy_hosts,proxyMode:r.proxyMode,proxy:r.proxy};E(a),e._applyProxySettings(r),n&&n(a)}))}function J(e,t){chrome.bookmarks.search({url:e},(function(e){e.forEach((function(e){chrome.bookmarks.remove(e.id)})),t&&t()}))}i.getWindows=function(e,t,n){chrome.tabs.query({currentWindow:!1},(function(t){const o={};t.forEach((e=>{const t=o[e.windowId]||[];t.push({title:e.title,url:e.url}),o[e.windowId]=t})),L(e,n,{windows:Object.keys(o).map((e=>({id:e,tabs:o[e],isPreviousChoice:parseInt(e)===N})))})}))},i.moveToWindow=function(e,t,n){-1===e.windowId?chrome.windows.create({tabId:t.tab.id}):chrome.tabs.move(t.tab.id,{windowId:e.windowId,index:-1},(()=>{_(e.windowId,t.tab.id)})),N=e.windowId},i.gatherWindows=function(e,t,n){const o=t.tab.windowId;chrome.tabs.query({currentWindow:!1},(function(e){e.forEach((function(e){chrome.tabs.move(e.id,{windowId:o,index:-1})}))}))},i.gatherTabs=function(e,t,n){const o=t.tab.windowId;e.tabs.forEach((function(e){chrome.tabs.move(e.id,{windowId:o,index:-1})}))},i.getBookmarkFolders=function(e,t,n){chrome.bookmarks.getTree((function(t){y=[],v(t[0],""),L(e,n,{folders:y})}))},i.createBookmark=function(e,t,n){J(e.page.url,(function(){w(e.page,(function(t){L(e,n,{bookmark:t})}))}))},i.getBookmarks=function(e,t,n){e.parentId?chrome.bookmarks.getSubTree(e.parentId,(function(t){var o=t[0].children;e.query&&e.query.length&&(o=D(o,e.query,e.caseSensitive)),L(e,n,{bookmarks:o})})):e.query&&e.query.length?chrome.bookmarks.search(e.query,(function(t){L(e,n,{bookmarks:D(t,e.query,e.caseSensitive)})})):chrome.bookmarks.getTree((function(t){L(e,n,{bookmarks:t[0].children})}))},i.getHistory=function(e,t,n){A(e.query||"",e.maxResults||100,(function(t){L(e,n,{history:t})}),e.sortByMostUsed)},i.addHistories=function(e,t,n){e.history.forEach((e=>{chrome.history.addUrl({url:e})}))},i.openLink=function(e,t,n){var o=function(e){return!/^view-source:|^javascript:/.test(e)&&/^(?:https?:\/\/)?(?:[^@\/\n]+@)?(?:www\.)?([^:\/\n]+)/im.test(e)&&(/^[\w-]+?:/i.test(e)||(e="http://"+e)),e}(e.url);o.startsWith("javascript:")?T(t.tab.id,0,{subject:"showBanner",message:"JavaScript URLs are not allowed in such operation."}):e.tab.tabbed?0!==t.frameId&&chrome.runtime.getURL("pages/frontend.html")===t.url||!t.tab?P((function(t){W(t,o,e)})):W(t.tab,o,e):chrome.tabs.update({url:o,pinned:e.tab.pinned||t.tab.pinned},(function(t){(e.scrollLeft||e.scrollTop)&&(m[t.id]={scrollLeft:e.scrollLeft,scrollTop:e.scrollTop})}))},i.viewSource=function(e,t,n){e.url="view-source:"+t.tab.url,i.openLink(e,t,n)},i.getSettings=function(t,n,o){var r=x;"RAW"===t.key&&(r=e.loadRawSettings,t.key=""),r(t.key,(function(n){void 0===t.key&&function(t){if(t.isMV3=c,t.useNeovim=e.nvimServer&&e.nvimServer.instance,t.isUserScriptsAvailable=B(),c&&(t.showAdvanced=t.isUserScriptsAvailable&&t.showAdvanced),t.isUserScriptsAvailable){const e="settingsSnippets";if(t.showAdvanced&&t.snippets){const n=t.snippets;chrome.userScripts.getScripts({ids:[e]},(t=>{const o=`import('./api.js').then((module) => {module.default("${chrome.runtime.getURL("/")}", (api, settings) => {${n}\n})});`,r=()=>{chrome.userScripts.register([{id:e,matches:["*://*/*","file:///*"],js:[{code:o}]}])};t.length>0?t[0].js[0].code!==o&&chrome.userScripts.unregister({ids:[e]},r):r()}))}else chrome.userScripts.getScripts({ids:[e]},(t=>{t.length>0&&chrome.userScripts.unregister({ids:[e]})}))}}(n),L(t,o,{settings:n})}))},i.updateSettings=function(e,t,n){let o="";if("snippets"===e.scope)for(var r in e.settings)g.hasOwnProperty(r)&&(g[r]=e.settings[r]);else e.settings.showAdvanced&&c?B()?(chrome.userScripts.configureWorld({csp:"script-src 'self' 'unsafe-eval'",messaging:!0}),E(e.settings)):o="Advanced mode is only available when Developer mode is turned on from chrome://extensions/.":E(e.settings);return{error:o}},i.setSurfingkeysIcon=function(e,t,n){let o="icons/48.png";"disabled"===e.status?o="icons/48-x.png":"lurking"===e.status&&(o="icons/48-l.png");(c?chrome.action:chrome.browserAction).setIcon({path:o,tabId:t.tab?t.tab.id:void 0})},i.request=function(e,t,o){n(e.url,(function(t){L(e,o,{text:t})}),e.headers,e.data)},i.requestImage=function(e,t,n){fetch(e.url,{method:"GET"}).then((e=>e.blob())).then((e=>createImageBitmap(e))).then((t=>{const o=new OffscreenCanvas(t.width,t.height);o.getContext("2d").drawImage(t,0,0,o.width,o.height),o.convertToBlob().then((t=>{const o=new FileReader;o.onload=function(t){L(e,n,{text:t.target.result})},o.readAsDataURL(t)}))})).catch((t=>{L(e,n,{text:""})}))},i.nextFrame=function(e,t,n){const o=t.tab.id;chrome.scripting.executeScript({target:{allFrames:!0,tabId:o},func:()=>"function"==typeof getFrameId?getFrameId():0},(function(t){if((t=t.map((e=>e.result)).filter((e=>e))).length>0){let n=0;for(n=0;n<t.length&&t[n]!==e.frameId;n++);n=n===t.length-1?0:n+1,T(o,-1,{subject:"focusFrame",frameId:t[n]})}}))},i.moveTab=function(e,t,n){chrome.tabs.query({windowId:t.tab.windowId},(function(n){var o=$(t.tab.index+e.step*e.repeats,n.length);chrome.tabs.move(t.tab.id,{index:o})}))},i.quit=function(e,t,n){V()},i.createSession=function(e,t,n){x("sessions",(function(t){chrome.tabs.query({},(function(n){var o={};n.forEach((function(e){e&&void 0!==e.index&&(o.hasOwnProperty(e.windowId)||(o[e.windowId]=[]),e.url!==b&&o[e.windowId].push(e.url))}));var r=[];for(var i in o)o[i].length&&r.push(o[i]);t.sessions[e.name]={},t.sessions[e.name].tabs=r,E({sessions:t.sessions},e.quitAfterSaved?V:void 0)}))}))},i.openSession=function(e,t,n){x("sessions",(function(t){if(t.sessions.hasOwnProperty(e.name)){var n=t.sessions[e.name].tabs;n[0].forEach((function(e){chrome.tabs.create({url:e,active:!1,pinned:!1})}));for(var o=1;o<n.length;o++){var r=n[o];chrome.windows.create({},(function(e){r.forEach((function(t){chrome.tabs.create({windowId:e.id,url:t,active:!1,pinned:!1})}))}))}chrome.tabs.query({url:b},(function(e){chrome.tabs.remove(e.map((function(e){return e.id})))}))}}))},i.deleteSession=function(e,t,n){x("sessions",(function(t){delete t.sessions[e.name],E({sessions:t.sessions})}))},i.closeDownloadsShelf=function(e,t,n){e.clearHistory?chrome.downloads.erase({urlRegex:".*"}):(chrome.downloads.setShelfEnabled(!1),chrome.downloads.setShelfEnabled(!0))},i.getDownloads=function(e,t,n){chrome.downloads.search(e.query,(function(t){L(e,n,{downloads:t})}))},i.download=function(e,t,n){chrome.downloads.download({url:e.url,saveAs:e.saveAs})},i.tabURLAccessed=function(e,t,n){if(t.tab){var o=t.tab.id;return k(o),p.hasOwnProperty(o)||(p[o]={}),p[o][e.url]=e.title,{active:t.tab.active,index:g.showTabIndices?t.tab.index+1:0}}return{}},i.getTabURLs=function(e,t,n){var o=p[t.tab.id]||{};return{urls:o=Object.keys(o).map((function(e){return{url:e,title:o[e]}}))}},i.getTopURL=function(e,t,n){return{url:t.tab?t.tab.url:""}},i.updateProxy=function(e,t,n){H(e,(function(t){L(e,n,t)}))},i.setZoom=function(e,t,n){var o=t.tab.id,r=e.zoomFactor*e.repeats;0==r?chrome.tabs.setZoom(o,1):chrome.tabs.getZoom(o,(function(e){chrome.tabs.setZoom(o,e+r)}))},i.removeURL=function(e,t,n){var o=0,r=e.uid.length,i=e.uid;function s(){++o===r&&L(e,n,{response:"Done"})}"string"==typeof e.uid&&(r=1,i=[e.uid]),i.forEach((function(e){!function(e,t){var n=e[0];e=e.substr(1),"B"===n?chrome.bookmarks.remove(e,t):"H"===n?chrome.history.deleteUrl({url:e},t):"T"===n?(e=e.split(":").map((function(e){return parseInt(e)})),chrome.windows.update(e[0],{focused:!0},(function(){chrome.tabs.remove(e[1],t)}))):"M"===n&&x("marks",(function(n){delete n.marks[e],E({marks:n.marks},t)}))}(e,s)}))},i.localData=function(e,t,n){e.data.constructor===Object?(chrome.storage.local.set(e.data,(function(){})),O(e.data)):chrome.storage.local.get(e.data,(function(t){L(e,n,{data:t})}))},i.captureVisibleTab=function(e,t,n){chrome.tabs.captureVisibleTab(null,{format:"png"},(function(t){L(e,n,{dataUrl:t})}))},i.getCaptureSize=function(e,t,n){var o=document.createElement("img");o.onload=function(){L(e,n,{width:o.width,height:o.height})},chrome.tabs.captureVisibleTab(null,{format:"png"},(function(e){o.src=e}))},i.deleteHistoryOlderThan=function(e,t,n){var o=e.days||0,r=e.hours||0;chrome.history.deleteRange({startTime:0,endTime:(new Date).getTime()-1e3*(86400*o+3600*r)},(function(){}))},i.removeBookmark=function(e,t,n){J(t.tab.url)},i.getBookmark=function(e,t,n){chrome.bookmarks.search({url:t.tab.url},(function(t){L(e,n,{bookmarks:t})}))},i.initGist=function(e,t,n){return a.initGist(e.token,(function(t){L(e,n,{gist:t})}))},i.readComment=function(e,t,n){a.readComment(e.index,(function(t){L(e,n,t)}))},i.editComment=function(e,t,n){a.editComment(e.index,e.content,(function(t){L(e,n,{gistResp:t})}))};var z=[];i.queueURLs=function(e,t,n){z=z.concat(e.urls)},i.getQueueURLs=function(e,t,n){return{queueURLs:z}},i.clearQueueURLs=function(e,t,n){z=[]},i.getVoices=function(e,t,n){chrome.tts.getVoices((function(t){L(e,n,{voices:t})}))},i.read=function(e,t,n){var o=e.options||{};o.onEvent=function(o){"start"===o.type?L(e,n,{ttsEvent:o}):T(t.tab.id,-1,{subject:"onTtsEvent",ttsEvent:o})},chrome.tts.speak(e.content,o)},i.stopReading=function(e,t,n){chrome.tts.stop()},i.openIncognito=function(e,t,n){chrome.windows.create({url:e.url,incognito:!0})},i.writeClipboard=function(e,t,n){navigator.clipboard.writeText(e.text)},i.readClipboard=function(e,t,n){chrome.runtime.sendNativeMessage("application.id",{message:"Clipboard.read"},(function(t){L(e,n,t)}))},i.getContainerName=e._getContainerName(i,L),chrome.runtime.setUninstallURL("http://brookhong.github.io/2018/01/30/why-did-you-uninstall-surfingkeys.html"),i.connectNative=function(t,n,o){e.nvimServer&&e.nvimServer.instance&&e.nvimServer.instance.then((({url:e,nm:n})=>{n.postMessage({mode:t.mode}),L(t,o,{url:e})})).catch((e=>{L(t,o,{error:e})}))}}({detectTabTitleChange:!0,getLatestHistoryItem:function(e,n,o){e.toLowerCase();let r=(new Date).getTime(),i=[];const s=(n,o,r)=>{const a=o*Math.pow(10,Math.min(2,e.length));chrome.history.search({startTime:0,endTime:n,text:"",maxResults:a},(function(a){const c=t(a,e,!1);i=[...i,...c],a.length<o||i.length>=o?r(i.slice(0,o)):(n=a[a.length-1].lastVisitTime-.01,s(n,o,r))}))};s(r,n,o)},loadRawSettings:function(e,t,n){var o=n||{};chrome.storage.local.get(null,(function(n){var a=n.savedAt||0;chrome.storage.sync.get(null,(function(c){var u=c.savedAt||0;a>u?(r(o,n),s(chrome.storage.sync,n,(function(){var n=i(o,e);chrome.runtime.lastError&&(n.error="Settings sync may not work thoroughly because of: "+chrome.runtime.lastError.message),t(n)}))):a<u?(delete c.localPath,r(o,c),t(i(o,e)),s(chrome.storage.local,c)):(r(o,n),t(i(o,e)))}))}))},nvimServer:u,_applyProxySettings:function(e){if(e.proxyMode&&"clear"!==e.proxyMode){var t=e.autoproxy_hosts.map((function(e){return e.filter((function(e){return-1!==e.indexOf("*")})).join("|")})),n=e.autoproxy_hosts.map((function(e){return o(e.filter((function(e){return-1===e.indexOf("*")})),1)})),r={mode:-1!==["always","byhost","bypass"].indexOf(e.proxyMode)?"pac_script":e.proxyMode,pacScript:{data:`var pacGlobal = {\n                        hosts: ${JSON.stringify(n)},\n                        autoproxy_pattern: ${JSON.stringify(t)},\n                        proxyMode: '${e.proxyMode}',\n                        proxy: ${JSON.stringify(e.proxy)}\n                    };\n                    function FindProxyForURL(url, host) {\n                        var lastPos;\n                        if (pacGlobal.proxyMode === "always") {\n                            return pacGlobal.proxy[0];\n                        } else if (pacGlobal.proxyMode === "bypass") {\n                            var pp = new RegExp(pacGlobal.autoproxy_pattern[0]);\n                            do {\n                                if (pacGlobal.hosts[0].hasOwnProperty(host)\n                                    || (pacGlobal.autoproxy_pattern[0].length && pp.test(host))) {\n                                    return "DIRECT";\n                                }\n                                lastPos = host.indexOf('.') + 1;\n                                host = host.slice(lastPos);\n                            } while (lastPos >= 1);\n                            return pacGlobal.proxy[0];\n                        } else {\n                            for (var i = 0; i < pacGlobal.proxy.length; i++) {\n                                var pp = new RegExp(pacGlobal.autoproxy_pattern[i]);\n                                var ahost = host;\n                                do {\n                                    if (pacGlobal.hosts[i].hasOwnProperty(ahost)\n                                        || (pacGlobal.autoproxy_pattern[i].length && pp.test(ahost))) {\n                                        return pacGlobal.proxy[i];\n                                    }\n                                    lastPos = ahost.indexOf('.') + 1;\n                                    ahost = ahost.slice(lastPos);\n                                } while (lastPos >= 1);\n                            }\n                            return "DIRECT";\n                        }\n                    }`}};chrome.proxy.settings.set({value:r,scope:"regular"},(function(){}))}else chrome.proxy.settings.clear({scope:"regular"})},_setNewTabUrl:function(){return"chrome://newtab/"},_getContainerName:function(e,t){}})})();